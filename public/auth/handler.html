<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Handler</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        console.log('Handler page loaded');
        
        // Fetch Firebase config from server
        fetch('/api/firebase-config')
            .then(response => response.json())
            .then(firebaseConfig => {
                console.log('Firebase config loaded', firebaseConfig);
                
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase initialized in handler');
                }
                
                console.log('Getting redirect result...');
                // Process the redirect result
                firebase.auth().getRedirectResult()
                    .then(result => {
                        console.log('Redirect result:', result);
                        if (result.user) {
                            console.log('User found in redirect result');
                            // Redirect to the original page
                            const urlParams = new URLSearchParams(window.location.search);
                            const redirectUrl = urlParams.get('redirectUrl');
                            if (redirectUrl) {
                                window.location.href = redirectUrl;
                            } else {
                                window.location.href = '/auth/welcome';
                            }
                        } else {
                            console.log('No user in redirect result');
                            // Check if we're in a popup
                            const urlParams = new URLSearchParams(window.location.search);
                            const authType = urlParams.get('authType');
                            
                            if (authType === 'signInViaPopup') {
                                console.log('This is a popup, closing');
                                // This is a popup, just close it
                                window.close();
                            } else {
                                console.log('Not a popup, redirecting to login');
                                // Not a popup, redirect to login
                                window.location.href = '/auth/login';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Redirect error:', error);
                        window.location.href = '/auth/login?error=' + encodeURIComponent(error.message);
                    });
            })
            .catch(error => {
                console.error('Config error:', error);
                window.location.href = '/auth/login?error=configuration_error';
            });
    </script>
</head>
<body>
    <div style="text-align: center; padding: 20px; font-family: Arial, sans-serif;">
        <h2>Completing authentication...</h2>
        <p>Please wait while we complete the authentication process.</p>
    </div>
</body>
</html>