<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Handler</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // Fetch Firebase config from server
        fetch('/api/firebase-config')
            .then(response => response.json())
            .then(firebaseConfig => {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // This page handles the authentication redirect
                firebase.auth().getRedirectResult()
                    .then((result) => {
                        if (result.user) {
                            // User is signed in, send token to server
                            return result.user.getIdToken().then(token => {
                                // Send the token to your backend
                                return fetch('/auth/google-signin', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        token: token,
                                        userData: {
                                            name: result.user.displayName,
                                            email: result.user.email,
                                            photo: result.user.photoURL
                                        }
                                    })
                                });
                            }).then(response => response.json())
                              .then(data => {
                                  if (data.success) {
                                      // Redirect to welcome page on success
                                      window.location.href = '/auth/welcome';
                                  } else {
                                      throw new Error('Server authentication failed');
                                  }
                              });
                        } else {
                            // No user from redirect, check if already signed in
                            const user = firebase.auth().currentUser;
                            if (user) {
                                // Already signed in, redirect to welcome
                                window.location.href = '/auth/welcome';
                            } else {
                                // No user, go back to login
                                window.location.href = '/auth/login';
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('Auth redirect error:', error);
                        window.location.href = '/auth/login?error=' + encodeURIComponent(error.message);
                    });
            })
            .catch(error => {
                console.error('Failed to load Firebase config:', error);
                window.location.href = '/auth/login?error=configuration_error';
            });
    </script>
</head>
<body>
    <div style="text-align: center; padding: 20px;">
        <p>Completing authentication...</p>
    </div>
</body>
</html>